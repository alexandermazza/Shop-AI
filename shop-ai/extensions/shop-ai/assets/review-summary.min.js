const ReviewSummary={async waitForJudgeMeReviews(e=2e4){let t=document.querySelectorAll(".jdgm-rev");return t.length>0?t:new Promise((t=>{let r=!1;const o=new MutationObserver((()=>{const e=document.querySelectorAll(".jdgm-rev");e.length>0&&(r=!0,o.disconnect(),t(e))}));o.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{if(!r){o.disconnect();const e=document.querySelectorAll(".jdgm-rev");t(e)}}),e)}))},async scrapeReviewContent(){let e=[];const t=await this.waitForJudgeMeReviews();if(t.length>0)t.forEach(((t,r)=>{if(r>=10)return;const o=t.querySelector(".jdgm-rev__rating"),n=t.querySelector(".jdgm-rev__body p"),s=t.querySelector(".jdgm-rev__body");let i="";n&&n.textContent.trim()?i=n.textContent.trim():s&&s.textContent.trim()&&(i=s.textContent.trim());const a=o&&(o.getAttribute("data-score")||o.textContent.trim())||"?";i&&e.push(`Rating: ${a}/5 - Comment: "${i}"`)}));else{let t=document.querySelectorAll(".spr-review");0===t.length&&(t=document.querySelectorAll(".shopify-product-reviews .review")),t.length>0&&t.forEach(((t,r)=>{if(r>=10)return;const o=t.querySelector(".spr-review-rating, .review-rating"),n=t.querySelector(".spr-review-content, .review-content"),s=o?o.textContent.trim().replace(/\s+/g," "):"?",i=n?n.textContent.trim().replace(/\s+/g," "):"";i&&e.push(`Rating: ${s}/5 - Comment: "${i}"`)}))}if(0===e.length)return null;return e.join("\n")},async onMount(e=document){if(!e||"review-summary-block"!==e.id)return void console.error("ReviewSummary: Invalid containerElement passed to onMount:",e);const t=e.querySelector(".summary-response-area"),r=t?.querySelector(".ai-summary-content"),o=t?.querySelector(".summary-attribution");if(!t||!r||!o)return console.error("ReviewSummary: Missing required elements."),t||console.error(">>> ReviewSummary: responseArea missing"),r||console.error(">>> ReviewSummary: summaryContentElement missing"),o||console.error(">>> ReviewSummary: attributionElement missing"),void(e.style.display="none");const n=await this.scrapeReviewContent();if(console.log("ReviewSummary: scrapedReviews to send:",n),!n)return void(e.style.display="none");e.classList.add("visible"),r.textContent="",t.classList.remove("error"),t.classList.add("loading"),o.classList.add("hidden");try{const s=await fetch("/apps/proxy/resource-review-summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({scrapedReviews:n})});if(!s.ok){let e=`API Error: ${s.status} ${s.statusText}`;try{const t=await s.text();t.startsWith("Error:")?e=t:s.headers.get("content-type")?.includes("text/html")?(e=`App Proxy Error ${s.status}: Check backend server or proxy config.`,console.error("ReviewSummary: Received HTML error page from App Proxy.")):console.warn("ReviewSummary: Received non-HTML, non-standard error response body:",t)}catch(e){console.error("ReviewSummary: Failed to read error response body:",e)}throw new Error(e)}if(!s.body)throw new Error("Response body is null, cannot read stream.");r.textContent="",t.classList.remove("loading"),e.classList.add("loaded");const i=s.body.pipeThrough(new TextDecoderStream).getReader();let a=!1;for(;;){const{value:e,done:o}=await i.read();if(o)break;if(!r.textContent&&"string"==typeof e&&e.trim().startsWith("Error:")){r.textContent=e.trim().replace(/^Error:/,"").trim(),t.classList.add("error"),a=!0;break}a||(r.textContent+=e)}o.classList.remove("hidden")}catch(n){console.log(">>> ReviewSummary: CATCH BLOCK ENTERED <<<"),console.error("ReviewSummary: Error during fetch or streaming:",n),r.textContent=`Error: ${n.message||"Could not load summary."}`,t.classList.remove("loading"),t.classList.add("error"),e.classList.add("loaded"),o.classList.remove("hidden")}}};window.ReviewSummary=ReviewSummary,document.addEventListener("shopify:section:load",(function(e){const t=e.detail.sectionId,r=document.getElementById(`shopify-section-${t}`);if(!r)return;const o=r.querySelector("#review-summary-block");o&&"true"!==o.dataset.initialized&&(ReviewSummary.onMount(o),o.dataset.initialized="true")})),document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll('#review-summary-block:not([data-initialized="true"])').forEach((e=>{ReviewSummary.onMount(e),e.dataset.initialized="true"}))}));