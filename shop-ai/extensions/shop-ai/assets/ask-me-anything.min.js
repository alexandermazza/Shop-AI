const AskMeAnything={async waitForJudgeMeReviews(e=2e4){let t=document.querySelectorAll(".jdgm-rev");return t.length>0?(console.log("AskMeAnything: Found .jdgm-rev reviews immediately:",t.length),t):new Promise((t=>{let n=!1;const o=new MutationObserver((()=>{const e=document.querySelectorAll(".jdgm-rev");e.length>0&&(n=!0,console.log("AskMeAnything: MutationObserver found .jdgm-rev reviews:",e.length),o.disconnect(),t(e))}));o.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{if(!n){o.disconnect();const e=document.querySelectorAll(".jdgm-rev");console.log("AskMeAnything: Timeout, found .jdgm-rev reviews:",e.length),t(e)}}),e)}))},async scrapeReviewContent(){console.log("AskMeAnything: Attempting to scrape review content from DOM.");let e="\nCustomer Reviews:\n",t=[];const n=await this.waitForJudgeMeReviews();if(n.length>0)console.log(`AskMeAnything: Processing ${n.length} Judge.me review elements.`),n.forEach(((e,n)=>{if(n>=5)return;const o=e.querySelector(".jdgm-rev__rating"),r=e.querySelector(".jdgm-rev__author");let s="";const i=e.querySelector(".jdgm-rev__body p"),a=e.querySelector(".jdgm-rev__body");i&&i.textContent.trim()?(s=i.textContent.trim(),console.log(`AskMeAnything: Review #${n+1} - Found body <p>:`,s)):a&&a.textContent.trim()?(s=a.textContent.trim(),console.log(`AskMeAnything: Review #${n+1} - Found body div:`,s)):(s="Review Text Missing",console.log(`AskMeAnything: Review #${n+1} - No review body found.`));const l=o&&(o.getAttribute("data-score")||o.textContent.trim())||"?",c=r?r.textContent.trim().replace(/\s+/g," "):"";t.push({rating:l,author:c,body:s})}));else{let e=document.querySelectorAll(".spr-review");0===e.length&&(e=document.querySelectorAll(".shopify-product-reviews .review")),e.length>0&&(console.log(`AskMeAnything: Found ${e.length} native Shopify review elements.`),e.forEach(((e,n)=>{if(n>=5)return;const o=e.querySelector(".spr-review-rating, .review-rating"),r=e.querySelector(".spr-review-author, .review-author"),s=e.querySelector(".spr-review-content, .review-content"),i=o?o.textContent.trim().replace(/\s+/g," "):"?",a=r?r.textContent.trim().replace(/\s+/g," "):"",l=s?s.textContent.trim().replace(/\s+/g," "):"Review Text Missing";t.push({rating:i,author:a,body:l})})))}return 0===t.length?(console.log("AskMeAnything: No review content scraped from the page."),"\nCustomer Reviews: No reviews found on this page.\n"):(t.forEach(((t,n)=>{e+=`- Review ${n+1}: Rating: ${t.rating}/5. ${t.author?"By: "+t.author+". ":""}Comment: "${t.body}"\n`})),console.log(`AskMeAnything: Scraped ${t.length} reviews.`),e)},async fetchJudgeMeReviews(e,t){if(console.log(`AskMeAnything: Fetching ALL Judge.me reviews via API for product ${e}`),!e||!t)return console.error("AskMeAnything: Missing productId or productUrl for API call."),"\nCustomer Reviews: Could not fetch reviews (missing product info).\n";const n=window.location.hostname;let o=[],r=1,s=0,i="\nCustomer Reviews:\n";try{for(;;){const e=`https://judge.me/api/v1/reviews?api_token=${window.Shopify?.shop}&shop_domain=${n}&handle=${t.split("/").pop()}&per_page=5&page=${r}`;console.log(`AskMeAnything: Fetching page ${r} from ${e}`);const a=await fetch(e);if(!a.ok){console.error(`AskMeAnything: Judge.me API request failed with status ${a.status}`);let e=`API Error (${a.status})`;try{e=(await a.json()).message||e}catch(e){}i+=` - Error fetching reviews: ${e}\n`;break}const l=await a.json();if(!l.reviews||0===l.reviews.length){console.log(`AskMeAnything: No more reviews found on page ${r}. Stopping fetch.`);break}l.reviews.forEach((e=>{const t=e.rating||"?",n=e.title||"",r=e.body||"No comment",i=e.reviewer?.name||"Anonymous";o.push({rating:t,author:i,title:n,body:r}),s++})),console.log(`AskMeAnything: Fetched ${l.reviews.length} reviews from page ${r}. Total fetched: ${s}`),r++,await new Promise((e=>setTimeout(e,300)))}}catch(e){return console.error("AskMeAnything: Error fetching or processing Judge.me API reviews:",e),i+=" - Error fetching reviews. Please try again later.\n",i}return 0===o.length?(console.log("AskMeAnything: No reviews fetched from the API."),"\nCustomer Reviews: No reviews found.\n"):(o.forEach(((e,t)=>{i+=`- Review ${t+1}: Rating: ${e.rating}/5. ${e.author?"By: "+e.author+". ":""}${e.title?'Title: "'+e.title+'". ':""}Comment: "${e.body}"\n`})),console.log(`AskMeAnything: Successfully formatted ${o.length} reviews from API.`),i)},onMount(e=document){if(console.log("AskMeAnything: onMount called for container:",e),!e||"ask-me-anything"!==e.id)return void console.error("AskMeAnything: Invalid containerElement passed to onMount:",e);const t=e.querySelector(".search-input"),n=e.querySelector(".response-area"),o=n?.querySelector(".ai-answer-content"),r=n?.querySelector("#powered-by-attribution"),s=e.dataset.productContext,i=e.dataset.productId,a=e.dataset.productUrl;if(!(t&&n&&o&&r&&s&&i&&a))return console.error("AskMeAnything: Missing required elements, product context, ID, or URL."),t||console.error(">>> searchInput missing"),n||console.error(">>> responseArea missing"),o||console.error(">>> answerContentElement missing"),r||console.error(">>> attributionElement missing"),s||console.error(">>> productContext missing"),i||console.error(">>> productId missing"),a||console.error(">>> productUrl missing"),void(n&&(n.textContent="Error: Could not initialize component.",n.style.display="block",n.className="response-area error"));console.log("AskMeAnything: Found elements and context.");const l=e.querySelector("form.ask-me-anything-form");l.addEventListener("submit",(async l=>{l.preventDefault();const c=t.value.trim();if(!c)return;const d=await this.fetchJudgeMeReviews(i,a),g=`${s}\n${d}`;o.textContent="",n.classList.remove("error"),n.classList.add("loading"),n.classList.add("visible"),r.classList.add("hidden"),t.disabled=!0;const u="/apps/proxy/resource-openai",h=e.getAttribute("data-language")||"en";console.log(`AskMeAnything: Calling API via App Proxy (streaming): ${u}`);let y=e.querySelector(".tone-of-voice-select");y||(y=document.createElement("select"),y.className="tone-of-voice-select",y.setAttribute("aria-label","Select tone of voice"),y.style.margin="0 0.5rem 0 0",[{value:"default",label:"Default"},{value:"professional",label:"Professional & Neutral"},{value:"friendly",label:"Friendly & Conversational"},{value:"playful",label:"Playful & Witty"},{value:"minimalist",label:"Minimalist / TL;DR"},{value:"luxury",label:"Luxury / High-End"},{value:"hype",label:"Hype & Trendy (Gen Z / TikTok Vibes)"},{value:"sassy",label:"Sassy / Bold"},{value:"detailed",label:"Detailed & Analytical"},{value:"parent",label:"Parent-Friendly / Family-Oriented"},{value:"outdoorsy",label:"Outdoorsy / Rugged"}].forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,y.appendChild(t)})),t&&t.parentNode&&t.parentNode.insertBefore(y,t));const m=y.value||"default";try{const e=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:c,productContext:g,language:h,toneOfVoice:"default"!==m?m:void 0})});if(!e.ok){let t=`API Error: ${e.status} ${e.statusText}`;try{const n=await e.text();n.startsWith("Error:")?t=n:e.headers.get("content-type")?.includes("text/html")?(t=`App Proxy Error ${e.status}: Check backend server or proxy config.`,console.error("Received HTML error page from App Proxy.")):console.warn("Received non-HTML, non-standard error response body:",n)}catch(e){console.error("AskMeAnything: Failed to read error response body:",e)}throw new Error(t)}if(!e.body)throw new Error("Response body is null, cannot read stream.");console.log("AskMeAnything: Receiving streamed response..."),o.textContent="",n.classList.remove("loading");const t=e.body.pipeThrough(new TextDecoderStream).getReader();for(;;){const{value:e,done:n}=await t.read();if(n){console.log("AskMeAnything: Stream finished.");break}o.textContent+=e}n.classList.add("visible"),r.classList.remove("hidden")}catch(e){console.error("AskMeAnything: Error during fetch or streaming:",e),o.textContent=`Error: ${e.message||"An unexpected error occurred."}`,n.classList.remove("loading"),n.classList.add("error","visible"),r.classList.remove("hidden")}finally{console.log("AskMeAnything: Re-enabling input."),t.disabled=!1,t.focus()}}));const c=e.querySelector("#suggested-questions-container");c&&s&&(c.innerHTML='<span class="loading-message">Loading suggestions...</span>',fetch("/apps/proxy/resource-openai",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({operation:"getSuggestedQuestions",productContext:s})}).then((e=>e.json())).then((e=>{e.suggestedQuestions&&Array.isArray(e.suggestedQuestions)?(c.innerHTML="",e.suggestedQuestions.forEach((e=>{const n=document.createElement("button");n.type="button",n.className="suggested-question-button",n.textContent=e,n.onclick=()=>{t.value=e,l.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0}))},c.appendChild(n)}))):c.innerHTML='<span class="loading-message" style="color:red;">No suggestions available.</span>'})).catch((()=>{c.innerHTML='<span class="loading-message" style="color:red;">Could not load suggestions.</span>'})))}};window.AskMeAnything=AskMeAnything,document.addEventListener("shopify:section:load",(function(e){console.log("AskMeAnything: shopify:section:load event fired.");const t=e.detail.sectionId,n=document.getElementById(`shopify-section-${t}`);if(!n)return void console.log("AskMeAnything: Section element not found for ID:",t);const o=n.querySelector("#ask-me-anything");o&&"true"!==o.dataset.initialized?(console.log("AskMeAnything: Initializing component via section:load."),AskMeAnything.onMount(o),o.dataset.initialized="true"):o?console.log("AskMeAnything: Component already initialized (section:load)."):console.log("AskMeAnything: Container #ask-me-anything not found in loaded section.")})),document.addEventListener("DOMContentLoaded",(()=>{console.log("AskMeAnything: DOMContentLoaded event fired."),document.querySelectorAll('#ask-me-anything:not([data-initialized="true"])').forEach((e=>{console.log("AskMeAnything: Initializing component via DOMContentLoaded."),AskMeAnything.onMount(e),e.dataset.initialized="true"}))}));