const AskMeAnything={async waitForJudgeMeReviews(e=2e4){let t=document.querySelectorAll(".jdgm-rev");return t.length>0?(console.log("AskMeAnything: Found .jdgm-rev reviews immediately:",t.length),t):new Promise((t=>{let n=!1;const o=new MutationObserver((()=>{const e=document.querySelectorAll(".jdgm-rev");e.length>0&&(n=!0,console.log("AskMeAnything: MutationObserver found .jdgm-rev reviews:",e.length),o.disconnect(),t(e))}));o.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{if(!n){o.disconnect();const e=document.querySelectorAll(".jdgm-rev");console.log("AskMeAnything: Timeout, found .jdgm-rev reviews:",e.length),t(e)}}),e)}))},async scrapeReviewContent(){console.log("AskMeAnything: Attempting to scrape review content from DOM.");let e="\nCustomer Reviews:\n",t=[];const n=await this.waitForJudgeMeReviews();if(n.length>0)console.log(`AskMeAnything: Processing ${n.length} Judge.me review elements.`),n.forEach(((e,n)=>{if(n>=5)return;const o=e.querySelector(".jdgm-rev__rating"),r=e.querySelector(".jdgm-rev__author");let s="";const i=e.querySelector(".jdgm-rev__body p"),l=e.querySelector(".jdgm-rev__body");i&&i.textContent.trim()?(s=i.textContent.trim(),console.log(`AskMeAnything: Review #${n+1} - Found body <p>:`,s)):l&&l.textContent.trim()?(s=l.textContent.trim(),console.log(`AskMeAnything: Review #${n+1} - Found body div:`,s)):(s="Review Text Missing",console.log(`AskMeAnything: Review #${n+1} - No review body found.`));const c=o&&(o.getAttribute("data-score")||o.textContent.trim())||"?",a=r?r.textContent.trim().replace(/\s+/g," "):"";t.push({rating:c,author:a,body:s})}));else{let e=document.querySelectorAll(".spr-review");0===e.length&&(e=document.querySelectorAll(".shopify-product-reviews .review")),e.length>0&&(console.log(`AskMeAnything: Found ${e.length} native Shopify review elements.`),e.forEach(((e,n)=>{if(n>=5)return;const o=e.querySelector(".spr-review-rating, .review-rating"),r=e.querySelector(".spr-review-author, .review-author"),s=e.querySelector(".spr-review-content, .review-content"),i=o?o.textContent.trim().replace(/\s+/g," "):"?",l=r?r.textContent.trim().replace(/\s+/g," "):"",c=s?s.textContent.trim().replace(/\s+/g," "):"Review Text Missing";t.push({rating:i,author:l,body:c})})))}return 0===t.length?(console.log("AskMeAnything: No review content scraped from the page."),"\nCustomer Reviews: No reviews found on this page.\n"):(t.forEach(((t,n)=>{e+=`- Review ${n+1}: Rating: ${t.rating}/5. ${t.author?"By: "+t.author+". ":""}Comment: "${t.body}"\n`})),console.log(`AskMeAnything: Scraped ${t.length} reviews.`),e)},onMount(e=document){if(console.log("AskMeAnything: onMount called for container:",e),!e||"ask-me-anything"!==e.id)return void console.error("AskMeAnything: Invalid containerElement passed to onMount:",e);const t=e.querySelector(".search-input"),n=e.querySelector(".response-area"),o=n?.querySelector(".ai-answer-content"),r=n?.querySelector("#powered-by-attribution"),s=e.dataset.productContext;if(!(t&&n&&o&&r&&s))return console.error("AskMeAnything: Missing required elements or product context."),t||console.error(">>> searchInput missing"),n||console.error(">>> responseArea missing"),o||console.error(">>> answerContentElement missing"),r||console.error(">>> attributionElement missing"),s||console.error(">>> productContext missing"),void(n&&(n.textContent="Error: Could not initialize component.",n.style.display="block",n.className="response-area error"));console.log("AskMeAnything: Found elements and context."),t.addEventListener("keypress",(async e=>{if("Enter"===e.key){e.preventDefault();const i=t.value.trim();if(!i)return;const l=await this.scrapeReviewContent(),c=`${s}\n${l}`;o.textContent="Thinking...",n.classList.remove("error"),n.classList.add("loading"),n.classList.add("visible"),r.classList.add("hidden"),t.disabled=!0;const a="/apps/proxy/resource-openai";console.log(`AskMeAnything: Calling API via App Proxy: ${a}`);try{const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:i,productContext:c})});if(!e.ok){let t=`API Error: ${e.status} ${e.statusText}`;if(e.headers.get("content-type")?.includes("text/html"))t=`App Proxy Error ${e.status}: Check backend server or proxy config.`,console.error("Received HTML error page from App Proxy.");else try{const n=await e.json();t=n.error||t,console.error("AskMeAnything: API Error (JSON Response):",n)}catch(t){e.headers.get("content-type")?.includes("text/html")||console.error("AskMeAnything: Failed to parse non-HTML error response body:",t)}throw new Error(t)}const t=await e.json();if(t.error)throw console.error("AskMeAnything: API Error (JSON Payload):",t),new Error(t.error);console.log("AskMeAnything: API Success, displaying answer."),o.textContent=t.answer,n.classList.remove("loading","error"),n.classList.add("visible"),r.classList.remove("hidden")}catch(e){console.error("AskMeAnything: Error during fetch or processing:",e),o.textContent=`Error: ${e.message||"An unexpected error occurred."}`,n.classList.remove("loading"),n.classList.add("error","visible"),r.classList.remove("hidden")}finally{console.log("AskMeAnything: Re-enabling input."),t.disabled=!1,t.focus()}}}))}};window.AskMeAnything=AskMeAnything,document.addEventListener("shopify:section:load",(function(e){console.log("AskMeAnything: shopify:section:load event fired.");const t=e.detail.sectionId,n=document.getElementById(`shopify-section-${t}`);if(!n)return void console.log("AskMeAnything: Section element not found for ID:",t);const o=n.querySelector("#ask-me-anything");o&&"true"!==o.dataset.initialized?(console.log("AskMeAnything: Initializing component via section:load."),AskMeAnything.onMount(o),o.dataset.initialized="true"):o?console.log("AskMeAnything: Component already initialized (section:load)."):console.log("AskMeAnything: Container #ask-me-anything not found in loaded section.")})),document.addEventListener("DOMContentLoaded",(()=>{console.log("AskMeAnything: DOMContentLoaded event fired."),document.querySelectorAll('#ask-me-anything:not([data-initialized="true"])').forEach((e=>{console.log("AskMeAnything: Initializing component via DOMContentLoaded."),AskMeAnything.onMount(e),e.dataset.initialized="true"}))}));